<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>画像ペアビューア</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        background: #222;
        color: #fff;
      }
      #image-info {
        margin-bottom: 1em;
        font-size: 1.3em;
      }
      #image-pair {
        display: flex;
        gap: 2vw;
        margin-bottom: 2vh;
        width: 90%; /* 幅を広げて確実に設定を適用 */
        align-items: flex-start; /* 高さの上端合わせ */
      }
      #img1 {
        flex: 3;
        max-width: 60%; /* max-widthを上書き */
        height: auto;
      }
      #img2 {
        flex: 2;
        max-width: 40%; /* max-widthを上書き */
        height: auto;
      }
      img {
        max-width: 40vw;
        max-height: 80vh;
        border-radius: 8px;
        box-shadow: 0 2px 16px #0008;
        background: #444;
      }
      #counter {
        font-size: 1.2em;
      }
      #slider-container {
        display: flex;
        justify-content: center;
        width: 80%;
        margin: 15px 0;
      }
      #image-slider {
        width: 100%;
        height: 20px;
        margin: 0;
      }
      .clickable {
        cursor: pointer;
        transition: transform 0.2s;
      }
      .clickable:hover {
        transform: scale(1.02);
      }
      /* モーダルスタイル */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        padding-top: 50px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.9);
      }
      .modal-content {
        margin: auto;
        display: block;
        max-width: 90%;
        max-height: 90vh;
      }
      .close {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1001;
      }
    </style>
  </head>
  <body>
    <div id="image-info"></div>
    <div id="image-pair">
      <img id="img2" src="" alt="画像2" class="clickable" />
      <img id="img1" src="" alt="画像1" class="clickable" />
    </div>
    <div id="counter"></div>
    <div id="slider-container" style="width: 80%; margin: 15px 0">
      <input
        type="range"
        id="image-slider"
        min="0"
        max="0"
        value="0"
        style="width: 100%"
      />
    </div>

    <!-- モーダル表示用の要素 -->
    <div id="image-modal" class="modal">
      <span class="close">&times;</span>
      <img id="modal-img" class="modal-content" src="" alt="拡大画像" />
    </div>
    <script>
      // imagesディレクトリのファイル名をAPIから取得
      let imageFiles = [];
      let imagePairs = [];
      let current = 0;
      const img1 = document.getElementById('img1');
      const img2 = document.getElementById('img2');
      const counter = document.getElementById('counter');
      const info = document.getElementById('image-info');
      const slider = document.getElementById('image-slider');
      function formatFilename(filename) {
        // MMDD_HHMM_1.jpg → M月D日 H時MM分
        const match = filename.match(/(\d{4})_(\d{4})_\d\.jpg/);
        if (!match) return filename;
        const mmdd = match[1];
        const hhmm = match[2];
        const month = parseInt(mmdd.slice(0, 2), 10);
        const day = parseInt(mmdd.slice(2, 4), 10);
        const hour = parseInt(hhmm.slice(0, 2), 10);
        const min = parseInt(hhmm.slice(2, 4), 10);
        return `${month}月${day}日 ${hour}時${min
          .toString()
          .padStart(2, '0')}分`;
      }
      function showPair(idx) {
        if (idx < 0 || idx >= imagePairs.length) return;
        const [f1, f2] = imagePairs[idx];
        img1.src = `images/${f1}`;
        img2.src = `images/${f2}`;
        img1.style.display = '';
        img2.style.display = '';
        img1.onerror = () => (img1.style.display = 'none');
        img2.onerror = () => (img2.style.display = 'none');
        counter.textContent = `${idx + 1} / ${imagePairs.length}`;
        info.textContent = formatFilename(f1);

        // スライダーの値を更新（イベントループを避けるためにchangeイベントを発生させない）
        slider.value = idx;
      }
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight') {
          if (current < imagePairs.length - 1) current++;
          showPair(current);
        } else if (e.key === 'ArrowLeft') {
          if (current > 0) current--;
          showPair(current);
        }
      });
      // スライダーのイベントリスナーを設定
      slider.addEventListener('input', function () {
        current = parseInt(this.value);
        showPair(current);
      });

      // モーダル関連の要素
      const modal = document.getElementById('image-modal');
      const modalImg = document.getElementById('modal-img');
      const closeBtn = document.querySelector('.close');

      // 画像クリックイベントの設定
      img1.addEventListener('click', function () {
        modal.style.display = 'block';
        modalImg.src = this.src;
      });

      img2.addEventListener('click', function () {
        modal.style.display = 'block';
        modalImg.src = this.src;
      });

      // モーダルを閉じる
      closeBtn.addEventListener('click', function () {
        modal.style.display = 'none';
      });

      // モーダル外クリックでも閉じる
      modal.addEventListener('click', function (e) {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });

      // Escキーでもモーダルを閉じる
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && modal.style.display === 'block') {
          modal.style.display = 'none';
        }
      });

      // APIから画像ファイル一覧を取得し、ペアを作成
      fetch('/api/images')
        .then((res) => res.json())
        .then((files) => {
          imageFiles = files;
          imagePairs = [];
          for (let i = 0; i < imageFiles.length; i += 2) {
            if (imageFiles[i + 1]) {
              imagePairs.push([imageFiles[i], imageFiles[i + 1]]);
            }
          }
          // スライダーの最大値を設定
          slider.max = imagePairs.length - 1;
          showPair(current);
        });
    </script>
  </body>
</html>
