# ScreenshotViewer.app とは？

> **ダブルクリックで「前日のスクリーンショット整理＆画像ビューア起動」！**

- **ScreenshotViewer.app** は Automator で作成したアプリケーションです。
- ダブルクリックで実行することで、
  1. 前日分（当日 AM4 時まで）のスクリーンショットを日付ごとに整理
  2. 画像ビューア（Web UI）を自動で起動
  3. Safari で画像ペアをすぐに閲覧可能
- **中身はシェルスクリプト実行**：
  - `process_screenshots.sh` を呼び出し、Node.js サーバーとブラウザを自動起動します。
  - Node.js サーバーの起動が必要なのは、画像ビューアがローカルサーバー上で動作するためです。
  - Automator の「シェルスクリプトを実行」アクションに以下を記述：
    ```sh
    export PATH="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH"
    cd /Users/chiha/projects-active/screenshot-scheduler
    /Users/chiha/projects-active/screenshot-scheduler/scripts/process_screenshots.sh
    ```

---

## ファイル構成

- `index.html`: 画像ペア表示のための HTML ファイル。自動再生・停止機能とホバー機能を含みます。
- `server.js`: Node.js サーバーの設定と API 実装。
- `/images`: 表示対象の画像ファイルを格納するディレクトリ。
- `scripts/`: 各種シェルスクリプト・launchd 用 plist を格納

---

## インストール・セットアップ

1. 必要な依存関係をインストール
   ```sh
   npm install
   ```
2. Automator で「アプリケーション」を作成し、上記のシェルスクリプトを設定
3. ダブルクリックで ScreenshotViewer.app を起動

---

## 使い方・運用方法

### スクリーンショットの自動取得

- Automator アプリを定期的に起動することで、Mac のスクリーンショットを自動で保存できます。
- 例: 1 分ごとに実行したい場合は、カレンダーやリマインダー、または別のスケジューラを利用してください。

### 古いスクリーンショットの自動削除

- 定期的に `scripts/cleanup.sh` を実行することで、2 日以上前の画像ファイルを自動で削除できます。
- Automator アプリやスケジューラで 1 日 1 回などの頻度で実行するのがおすすめです。

### launchd（macOS 標準）による自動削除の設定方法

- `scripts/com.chiha.cleanup.plist` を `~/Library/LaunchAgents/` にコピーし、`launchctl load` で登録
- 詳細は該当セクション参照

---

## 主要スクリプトの説明

| スクリプト名                      | 役割・特徴                                                                              |
| :-------------------------------- | :-------------------------------------------------------------------------------------- |
| `scripts/capture.sh`              | すべてのディスプレイのスクリーンショットを撮影し、`~/Pictures/Screenshots` に保存します |
| `scripts/cleanup.sh`              | 2 日以上前のスクリーンショット画像（.png）を自動で削除します                            |
| `scripts/process_screenshots.sh`  | 前日のスクリーンショットをサブディレクトリに移動し、画像ビューアを起動します            |
| `scripts/com.chiha.cleanup.plist` | launchd 用の設定ファイル。`cleanup.sh`を毎日自動実行するために使用します                |

---

## 画像ビューア（index.html）の主な機能

- 画像ペア表示・自動再生・停止・拡大表示・キーボード操作
- サーバー終了ボタンで安全に Node.js サーバーを停止可能

---

## サーバーの手動終了・ポート解放機能（2025/06/07 追加）

- 画像ビューア（index.html）に「サーバー終了」ボタンを追加
  - ボタンを押すと Node.js サーバーが安全に停止し、ポート 3000 が解放されます
- サーバー側（server.js）に `/shutdown` エンドポイントを追加し、POST リクエストでサーバーを終了できます

---

## ポート 3000 の使用状況をターミナルで確認する方法

```zsh
lsof -i :3000
```

または

```zsh
sudo lsof -nP -iTCP:3000 | grep LISTEN
```

- 上記コマンドでポート 3000 を使用しているプロセス（PID やコマンド名）が表示されます

---

## サーバープロセスを手動で終了させる方法

1. ポート 3000 を使っているプロセスの PID を調べる：
   ```zsh
   lsof -i :3000
   ```
   例：
   ```
   node    12345 user   22u  IPv6 0x...      0t0  TCP *:3000 (LISTEN)
   ```
   → この場合、PID は `12345`
2. プロセスを終了する：
   ```zsh
   kill 12345
   ```
   必要に応じて `kill -9 12345` も利用できます（強制終了）

---

## 注意

- 「サーバー終了」ボタンを使うと安全に Node.js サーバーが停止します
- ターミナルからも上記手順で手動終了・ポート解放が可能です

---

## 注意事項・Tips

### 画面収録権限について

- スクリーンショットが壁紙のみになる場合は、**システム設定 > プライバシーとセキュリティ > 画面収録** で「ターミナル」に画面収録の権限を与えてください
- 権限を付与した後は、**Mac の再起動**が必要です

### Automator での環境変数について

- Automator でシェルスクリプトを実行する場合、ターミナルとは異なり PATH などの環境変数が異なります
- そのため、ImageMagick の convert など外部コマンドを使う場合は、必ずフルパス（例: /usr/local/bin/convert）で指定してください

### ファイル名の形式

- `MMDD_HHMM_ディスプレイ番号.png` 形式で保存されます（例: `0531_0913_1.png`）
- 複数ディスプレイが接続されている場合、各ディスプレイごとに保存されます

---

## 詳細運用・自動化例

### Automator・crontab・launchd による自動化例や設定方法

- 詳細は該当セクション・スクリプトコメントを参照

---

## 変更履歴

### 2025/06/02 画像ペアビューアの UI・操作性アップデート

- 拡大モーダル表示時、画像上部に日時、下部にショートカット説明を重ねて表示
- モーダル時・通常時ともにショートカット説明のデザイン・内容を統一
- モーダル時のキー操作（a/d/←/→/Esc）で拡大画像の切り替えやペア移動が可能
- コードをリファクタリングし、ショートカット説明のスタイルを共通クラス化
- 1 ファイル構成（index.html）を維持しつつ、保守性・可読性を向上

### 2025/06/04 process_screenshots.sh の新しい動作仕様

- スクリーンショットの「1 日」の区切りを「AM4:00 ～翌日 AM4:00」としています
- ファイル名に日付が含まれていなくても、ファイルの作成日時・更新日時で判定します
- 画像ファイル（.jpg, .png）が対象です
- これにより、夜更かしや深夜作業の分も「前日分」としてまとめて整理できます

### 2025/06/07 サーバーの手動終了・ポート解放機能追加

- index.html に「サーバー終了」ボタンを追加
- server.js に /shutdown エンドポイントを追加
- README にポート確認・手動 kill 方法を追記
